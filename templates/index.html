<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Spotify Bot Control</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-800 to-indigo-900 min-h-screen flex items-center justify-center p-4 overflow-y-auto">
    <div class="main-container bg-gray-800 bg-opacity-90 p-8 md:p-12 rounded-xl shadow-2xl w-full max-w-5xl text-white border border-purple-700 grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="lg:col-span-2 mb-6 space-y-3">
                    {% for category, message in messages %}
                        <div class="p-4 rounded-lg text-sm {% if category == 'success' %}bg-green-600{% elif category == 'error' %}bg-red-600{% else %}bg-blue-600{% endif %} bg-opacity-80 shadow-md">
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <!-- Left Column: Now Playing -->
        <div class="now-playing-card p-6 bg-gray-700 bg-opacity-70 rounded-xl shadow-lg flex flex-col items-center text-center">
            <h2 class="text-3xl font-bold mb-6 text-purple-300">Now Playing</h2>
            
            <div id="welcomeState" class="flex flex-col items-center justify-center h-full min-h-[300px] w-full p-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="96" height="96" viewBox="0 0 24 24" fill="none" stroke="#a78bfa" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-music-4 mb-4">
                    <path d="M11 17L4 19V9l7-2"></path><path d="M11 17a2 2 0 002 2c1.8 0 3-1.8 3-2s-1.2-2-3-2a2 2 0 00-2 2Z"></path><path d="M13 5v14"></path><path d="M16 5a2 2 0 002 2c1.8 0 3-1.8 3-2s-1.2-2-3-2a2 2 0 00-2 2Z"></path>
                </svg>
                <h3 class="text-3xl font-bold text-white mb-2">Welcome to your Music Bot</h3>
                <p class="text-purple-200 text-lg">Get started by searching for a song!</p>

                <div class="mt-8 w-full">
                    <form action="{{ url_for('add_search_web_control', _external=True, _scheme='https') }}" method="post" class="flex flex-col md:flex-row gap-3 w-full">
                        <input type="text" id="searchOrUrlInput" name="query" placeholder="ชื่อเพลง, ศิลปิน, หรือ URL (Spotify/YouTube)"
                               class="flex-grow p-3 rounded-lg bg-gray-600 border border-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white placeholder-gray-400">
                        <button type="submit" class="px-6 py-3 bg-purple-600 hover:bg-purple-700 rounded-lg shadow-md font-semibold transition duration-300">
                            เล่น/เพิ่ม
                        </button>
                    </form>
                </div>
            </div>

            <div id="nowPlayingState" class="hidden w-full flex flex-col items-center">
                <img id="currentCoverImage" src="https://placehold.co/400x400/94a3b8/ffffff?text=No+Cover" alt="Album Cover" class="w-48 h-48 rounded-lg shadow-lg mb-6">
                <h3 id="currentSongTitle" class="text-2xl font-bold text-white mb-1"></h3>
                <p id="currentArtistName" class="text-purple-200 text-lg mb-4"></p>
                
                <div class="progress-container w-full max-w-md mb-6">
                    <div class="flex justify-between text-sm text-gray-300 mb-1">
                        <span id="elapsedTime">0:00</span>
                        <span id="totalTime">0:00</span>
                    </div>
                    <div class="progress-bar-bg">
                        <div id="actualProgressBar" class="progress-fill"></div>
                    </div>
                </div>

                <div class="controls flex items-center justify-center gap-6 mb-6">
                    <button id="shuffleBtn" class="control-btn p-3 rounded-full hover:bg-purple-600 focus:outline-none">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shuffle"><path d="M2 17h2a4 4 0 0 0 4 4 4 4 0 0 0 4-4V7a4 4 0 0 0-4-4H2"/><path d="M22 17h-2a4 4 0 0 0-4-4 4 4 0 0 0-4 4v0a4 4 0 0 0 4 4h2"/><path d="M12 17l8-8"/><path d="M12 7l8 8"/></svg>
                    </button>
                    <button id="prevBtn" class="control-btn p-3 rounded-full hover:bg-purple-600 focus:outline-none">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-skip-back"><polygon points="19 20 9 12 19 4 19 20"/><line x1="5" x2="5" y1="19" y2="5"/></svg>
                    </button>
                    <button id="playPauseBtn" class="control-btn main-play-btn w-16 h-16 flex items-center justify-center rounded-full bg-purple-500 hover:bg-purple-600 focus:outline-none">
                        <svg id="playIcon" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-play"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                        <svg id="pauseIcon" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pause" style="display: none;"><rect width="4" height="16" x="6" y="4"/><rect width="4" height="16" x="14" y="4"/></svg>
                    </button>
                    <button id="nextBtn" class="control-btn p-3 rounded-full hover:bg-purple-600 focus:outline-none">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-skip-forward"><polygon points="5 4 15 12 5 20 5 4"/><line x1="19" x2="19" y1="5" y2="19"/></svg>
                    </button>
                    <button id="loopBtn" class="control-btn p-3 rounded-full hover:bg-purple-600 focus:outline-none">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-repeat"><path d="M17 2H9A3 3 0 0 0 6 5v.34c0 1.42-.31 2.84-.9 4.14C4.38 11.66 2 13.86 2 18a4 4 0 0 0 4 4h14a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-1"></path><path d="m14 7 3-3 3 3"></path><path d="M7 17l-3 3-3-3"></path></svg>
                    </button>
                </div>

                <div class="volume-control w-full max-w-xs flex items-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-volume-2 text-purple-200"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>
                    <input type="range" id="volumeSlider" min="0" max="100" value="70" class="flex-grow">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-volume-x-2 text-purple-200"><path d="M11 5 6 9H2v6h4l5 4V5z"/><line x1="22" y1="9" x2="16" y2="15"/><line x1="16" y2="9" x2="22" y2="15"/></svg>
                </div>
            </div>
        </div>

        <!-- Right Column: Queue & Auth Status -->
        <div class="right-column-container flex flex-col gap-8">
            <!-- Queue Section -->
            <div class="queue-card p-6 bg-gray-700 bg-opacity-70 rounded-xl shadow-lg flex-grow">
                <h2 class="text-3xl font-bold mb-6 text-purple-300">Queue <span class="text-purple-400 text-2xl font-bold">+</span></h2>
                <div id="queueContent">
                    <p class="text-purple-200 text-lg text-center mt-8">Queue is empty. Search for songs to add!</p>
                </div>
                <ul id="queueList" class="space-y-3 mt-4 hidden">
                    <!-- Queue items will be dynamically added here by JavaScript -->
                </ul>
            </div>

            <!-- Connection Status (Auth) -->
            <div class="auth-card p-6 bg-gray-700 bg-opacity-70 rounded-xl shadow-lg">
                <h2 class="text-3xl font-bold mb-6 text-purple-300">สถานะการเชื่อมต่อ</h2>
                <div class="space-y-4">
                    <div class="flex items-center text-lg justify-between">
                        <span class="text-white">Discord:</span>
                        <div id="discordStatus" class="flex items-center gap-2">
                            <span class="text-red-400 font-medium">ยังไม่เชื่อมโยง</span>
                            <a href="{{ url_for('login_discord', _external=True, _scheme='https') }}" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg shadow-md transition duration-300 text-sm">เข้าสู่ระบบ Discord</a>
                        </div>
                    </div>
                    <div class="flex items-center text-lg justify-between">
                        <span class="text-white">Spotify:</span>
                        <div id="spotifyStatus" class="flex items-center gap-2">
                            <span class="text-red-400 font-medium">ยังไม่เชื่อมโยง</span>
                            {% if is_discord_linked %}
                                <a id="spotifyLoginLink" href="{{ url_for('login_spotify_web', discord_user_id_param=discord_user_id, _external=True, _scheme='https') }}" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg shadow-md transition duration-300 text-sm">เชื่อมโยง Spotify</a>
                            {% else %}
                                <span class="text-gray-400 text-sm">เข้าสู่ระบบ Discord ก่อน</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK (CDN) - Adjusted to load compat versions -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    
    <script>
        // Global variables for Firebase config from Flask backend
        const FIREBASE_CONFIG = {{ firebase_config | tojson }};
        const APP_ID = "{{ app_id | safe }}";
        const INITIAL_AUTH_TOKEN = {{ initial_auth_token | tojson }};

        // Flask-generated URLs passed to JavaScript
        const urls = {
            getAuthStatus: "{{ url_for('get_auth_status_api', _external=True, _scheme='https') }}",
            loginDiscord: "{{ url_for('login_discord', _external=True, _scheme='https') }}",
            // Removed loginSpotifyWeb as it's dynamically constructed in JS
            addOrSearch: "{{ url_for('add_search_web_control', _external=True, _scheme='https') }}",
            pauseControl: "{{ url_for('pause_web_control', _external=True, _scheme='https') }}",
            resumeControl: "{{ url_for('resume_web_control', _external=True, _scheme='https') }}",
            skipControl: "{{ url_for('skip_web_control', _external=True, _scheme='https') }}",
            skipPreviousControl: "{{ url_for('skip_previous_web_control', _external=True, _scheme='https') }}",
            stopControl: "{{ url_for('stop_web_control', _external=True, _scheme='https') }}",
            setVolumeControl: "{{ url_for('set_volume_web_control', _external=True, _scheme='https') }}",
            getNowPlayingData: "{{ url_for('get_now_playing_data', _external=True, _scheme='https') }}",
            getQueueData: "{{ url_for('get_queue_data', _external=True, _scheme='https') }}",
            toggleShuffle: "{{ url_for('toggle_shuffle_web_control', _external=True, _scheme='https') }}",
            toggleLoop: "{{ url_for('toggle_loop_web_control', _external=True, _scheme='https') }}"
        };
    </script>
    <!-- Your main JavaScript file -->
    <script src="{{ url_for('static', filename='index.js') }}"></script>
</body>
</html>
